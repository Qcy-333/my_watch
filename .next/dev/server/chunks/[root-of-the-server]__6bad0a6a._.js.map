{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 118, "column": 0}, "map": {"version":3,"sources":["file:///E:/1_my_projects/my_watch/lib/lark.ts"],"sourcesContent":["import axios from 'axios';\n\nconst APP_ID = process.env.APP_ID;\nconst APP_SECRET = process.env.APP_SECRET;\nconst APP_TOKEN = process.env.APP_TOKEN; // Base Token\nconst TABLE_ID = process.env.TABLE_ID;\n\nlet tokenCache: { token: string; expiresAt: number } | null = null;\n\nasync function getTenantAccessToken() {\n  if (tokenCache && Date.now() < tokenCache.expiresAt) {\n    return tokenCache.token;\n  }\n\n  const url = \"https://open.feishu.cn/open-apis/auth/v3/tenant_access_token/internal\";\n  const response = await axios.post(url, {\n    app_id: APP_ID,\n    app_secret: APP_SECRET,\n  });\n\n  if (response.data.code !== 0) {\n    throw new Error(`Failed to get access token: ${response.data.msg}`);\n  }\n\n  tokenCache = {\n    token: response.data.tenant_access_token,\n    expiresAt: Date.now() + (response.data.expire - 300) * 1000,\n  };\n\n  return tokenCache.token;\n}\n\nexport async function fetchToWatchVideos() {\n  const token = await getTenantAccessToken();\n  const url = `https://open.feishu.cn/open-apis/bitable/v1/apps/${APP_TOKEN}/tables/${TABLE_ID}/records/search`;\n  \n  const response = await axios.post(url, {\n    filter: {\n      conjunction: \"and\",\n      conditions: [\n        {\n          field_name: \"状态\",\n          operator: \"is\",\n          value: [\"待看\"]\n        }\n      ]\n    },\n    automatic_fields: true \n  }, {\n    headers: { Authorization: `Bearer ${token}` }\n  });\n\n  if (response.data.code !== 0) {\n    throw new Error(`Failed to fetch videos: ${response.data.msg}`);\n  }\n\n  return response.data.data.items;\n}\n\nexport async function deleteVideoRecord(recordId: string) {\n  const token = await getTenantAccessToken();\n  const url = `https://open.feishu.cn/open-apis/bitable/v1/apps/${APP_TOKEN}/tables/${TABLE_ID}/records/${recordId}`;\n\n  const response = await axios.delete(url, {\n    headers: { Authorization: `Bearer ${token}` }\n  });\n\n  if (response.data.code !== 0) {\n    throw new Error(`Failed to delete video: ${response.data.msg}`);\n  }\n\n  return response.data;\n}\n\nexport async function updateVideoStatus(recordId: string, status: 'Done' | 'Trash', note?: string) {\n  // If status is Trash, we delete the record entirely\n  if (status === 'Trash') {\n    return deleteVideoRecord(recordId);\n  }\n\n  const token = await getTenantAccessToken();\n  const url = `https://open.feishu.cn/open-apis/bitable/v1/apps/${APP_TOKEN}/tables/${TABLE_ID}/records/${recordId}`;\n  \n  const fields: any = {};\n  \n  if (status === 'Done') {\n    fields[\"状态\"] = \"已看\";\n  }\n\n  if (note) {\n    // Note field \"笔记\" is a text field\n    fields[\"笔记\"] = note;\n  }\n\n  const response = await axios.put(url, { fields }, {\n    headers: { Authorization: `Bearer ${token}` }\n  });\n\n   if (response.data.code !== 0) {\n    throw new Error(`Failed to update video: ${response.data.msg}`);\n  }\n  \n  return response.data.data.record;\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 222, "column": 0}, "map": {"version":3,"sources":["file:///E:/1_my_projects/my_watch/app/api/videos/route.ts"],"sourcesContent":["import { NextResponse } from 'next/server';\nimport { fetchToWatchVideos } from '@/lib/lark';\n\nexport async function GET() {\n  try {\n    const records = await fetchToWatchVideos();\n    \n    // Transform to ContentRecord format with Chinese keys\n    const formatted = records.map((r: any) => ({\n      id: r.record_id,\n      title: getTextValue(r.fields[\"标题\"]),\n      // Handle Link object or string\n      url: r.fields[\"链接\"]?.link || r.fields[\"链接\"] || '', \n      // Platform mapping\n      platform: mapPlatform(r.fields[\"来源\"]),\n      status: 'ToWatch', // We only fetch ToWatch ('待看')\n      tags: r.fields[\"主要标签\"] || [],\n      summary: getTextValue(r.fields[\"内容\"]), \n      // created_time is in seconds\n      createdAt: r.created_time ? new Date(r.created_time * 1000).toISOString() : new Date().toISOString()\n    }));\n\n    return NextResponse.json(formatted);\n  } catch (error: any) {\n    console.error(\"API Error:\", error);\n    return NextResponse.json({ error: error.message }, { status: 500 });\n  }\n}\n\nfunction getTextValue(field: any): string {\n  if (!field) return '';\n  if (typeof field === 'string') return field;\n  if (Array.isArray(field)) {\n    return field.map((item: any) => item.text || '').join('');\n  }\n  return '';\n}\n\nfunction mapPlatform(source: any): string {\n  if (Array.isArray(source)) source = source[0];\n  if (!source) return 'Web';\n  \n  const s = source.toLowerCase();\n  if (s.includes('bilibili') || s.includes('b23')) return 'Bilibili';\n  if (s.includes('xhs') || s.includes('小红书')) return 'XiaoHongShu';\n  if (s.includes('youtube')) return 'YouTube';\n  if (s.includes('article') || s.includes('公众号')) return 'Article';\n  \n  return 'Web';\n}\n"],"names":[],"mappings":";;;;AAAA;AACA;;;AAEO,eAAe;IACpB,IAAI;QACF,MAAM,UAAU,MAAM,IAAA,mIAAkB;QAExC,sDAAsD;QACtD,MAAM,YAAY,QAAQ,GAAG,CAAC,CAAC,IAAW,CAAC;gBACzC,IAAI,EAAE,SAAS;gBACf,OAAO,aAAa,EAAE,MAAM,CAAC,KAAK;gBAClC,+BAA+B;gBAC/B,KAAK,EAAE,MAAM,CAAC,KAAK,EAAE,QAAQ,EAAE,MAAM,CAAC,KAAK,IAAI;gBAC/C,mBAAmB;gBACnB,UAAU,YAAY,EAAE,MAAM,CAAC,KAAK;gBACpC,QAAQ;gBACR,MAAM,EAAE,MAAM,CAAC,OAAO,IAAI,EAAE;gBAC5B,SAAS,aAAa,EAAE,MAAM,CAAC,KAAK;gBACpC,6BAA6B;gBAC7B,WAAW,EAAE,YAAY,GAAG,IAAI,KAAK,EAAE,YAAY,GAAG,MAAM,WAAW,KAAK,IAAI,OAAO,WAAW;YACpG,CAAC;QAED,OAAO,gJAAY,CAAC,IAAI,CAAC;IAC3B,EAAE,OAAO,OAAY;QACnB,QAAQ,KAAK,CAAC,cAAc;QAC5B,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO,MAAM,OAAO;QAAC,GAAG;YAAE,QAAQ;QAAI;IACnE;AACF;AAEA,SAAS,aAAa,KAAU;IAC9B,IAAI,CAAC,OAAO,OAAO;IACnB,IAAI,OAAO,UAAU,UAAU,OAAO;IACtC,IAAI,MAAM,OAAO,CAAC,QAAQ;QACxB,OAAO,MAAM,GAAG,CAAC,CAAC,OAAc,KAAK,IAAI,IAAI,IAAI,IAAI,CAAC;IACxD;IACA,OAAO;AACT;AAEA,SAAS,YAAY,MAAW;IAC9B,IAAI,MAAM,OAAO,CAAC,SAAS,SAAS,MAAM,CAAC,EAAE;IAC7C,IAAI,CAAC,QAAQ,OAAO;IAEpB,MAAM,IAAI,OAAO,WAAW;IAC5B,IAAI,EAAE,QAAQ,CAAC,eAAe,EAAE,QAAQ,CAAC,QAAQ,OAAO;IACxD,IAAI,EAAE,QAAQ,CAAC,UAAU,EAAE,QAAQ,CAAC,QAAQ,OAAO;IACnD,IAAI,EAAE,QAAQ,CAAC,YAAY,OAAO;IAClC,IAAI,EAAE,QAAQ,CAAC,cAAc,EAAE,QAAQ,CAAC,QAAQ,OAAO;IAEvD,OAAO;AACT"}}]
}